<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Ollama NER Bearbetning</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #status-log { 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 300px; 
            overflow-y: scroll; 
            background: #f4f4f4;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; }
        .info { color: gray; }
        button:disabled { background-color: #ddd; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>NER Bearbetning med Ollama</h1>
    <p>Kör NER-extraktion på filen <code>{{ config.INPUT_FILE }}</code> med modellen <code>{{ config.MODEL_NAME }}</code>.</p>
    
    <button id="startButton">Starta Bearbetning</button>
    
    <h2>Statusfält:</h2>
    <pre id="status-log"></pre>

    <script>
        const startButton = document.getElementById('startButton');
        const statusLog = document.getElementById('status-log');
        let eventSource = null;
        // FLAGGA: Håller koll på om servern har signalerat att processen är klar.
        let is_done_by_server = false; 

        // Funktion för att uppdatera loggfältet
        function appendToLog(message, level) {
            const entry = document.createElement('div');
            entry.textContent = message;
            // Säkerställer att level alltid är en sträng (t.ex. ERROR, INFO)
            entry.className = (level || 'INFO').toLowerCase();
            statusLog.appendChild(entry);
            // Scrolla ner automatiskt
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // Kontrollerar status vid sidladdning
        async function checkStatus() {
            try {
                const response = await fetch('/is_running');
                const data = await response.json();
                if (data.is_running) {
                    startButton.disabled = true;
                    startButton.textContent = 'Bearbetning pågår...';
                    startStreaming();
                } else {
                    startButton.disabled = false;
                    startButton.textContent = 'Starta Bearbetning';
                }
            } catch (error) {
                appendToLog("Kunde inte ansluta till serverns status-API.", "ERROR");
            }
        }

        // Startar realtidsströmmen (Server-Sent Events)
        function startStreaming() {
            // Förhindra dubbel anslutning
            if (eventSource) {
                eventSource.close();
            }
            
            is_done_by_server = false; // Återställ flaggan vid ny start

            eventSource = new EventSource("/status_stream");

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.log === "__END__") {
                    // Steg 1: Markera att processen är avslutad av servern
                    is_done_by_server = true; 

                    // Processen är avslutad
                    appendToLog("Bearbetning avslutad. Resultat sparat.", "SUCCESS");
                    startButton.disabled = false;
                    startButton.textContent = 'Starta Bearbetning (Klar)';
                    eventSource.close();
                    eventSource = null;
                    return;
                }
                
                const message = data.log;
                // Extrahera loggnivån från meddelandet, t.ex. "[ERROR]", "[WARNING]", "[INFO]"
                let level = "INFO";
                const match = message.match(/^\[(ERROR|WARNING|SUCCESS|INFO)\]/);
                if (match) {
                    level = match[1];
                }
                
                appendToLog(message, level);
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                
                // Steg 2: Fånga felet. Stäng eventuellt anslutningen för att stoppa automatisk återanslutning 
                // OM servern redan signalerat att den är klar.
                if (is_done_by_server) {
                    // Om servern har signalerat __END__, stäng anslutningen explicit för att stoppa loopen
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    startButton.disabled = false;
                    startButton.textContent = 'Starta Bearbetning (Klar)';
                } else {
                    // Om processen fortfarande borde vara igång, logga ett nätverksfel
                    appendToLog("Anslutning avbröts. Försöker återansluta...", "WARNING");
                    // Webbläsaren hanterar återanslutning automatiskt här.
                }
            };
            
            // Logga start av streamingen
            appendToLog("Realtidsstatus aktiverad...", "INFO");
        }

        // Hanterare för knappen
        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            statusLog.innerHTML = ''; // Rensa gamla loggar
            appendToLog("Skickar begäran om att starta bearbetning...", "INFO");
            
            try {
                const response = await fetch('/start_process', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    startButton.textContent = 'Bearbetning pågår...';
                    startStreaming();
                } else {
                    appendToLog(`Kunde inte starta: ${data.message}`, "ERROR");
                    startButton.disabled = false;
                    startButton.textContent = 'Starta Bearbetning';
                }
            } catch (error) {
                appendToLog(`Nätverksfel vid start: ${error}`, "ERROR");
                startButton.disabled = false;
                startButton.textContent = 'Starta Bearbetning';
            }
        });

        // Kör statuskontroll vid laddning
        checkStatus();
    </script>
</body>
</html>